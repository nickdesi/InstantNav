(function(){"use strict";class p{constructor(){this.links=[],this.scores=new Map,this.graceTimers=new Map,this.lastBatchTime=0,this._setupObserver(),this._initBatteryStatus(),this._scanLinks()}async _initBatteryStatus(){if(navigator.getBattery)try{const t=await navigator.getBattery();this.isCharging=t.charging,t.addEventListener("chargingchange",()=>{this.isCharging=t.charging})}catch{this.isCharging=!0}else this.isCharging=!0}_setupObserver(){new MutationObserver(()=>{this._scanLinks()}).observe(document.body,{childList:!0,subtree:!0})}_scanLinks(){this.links=Array.from(document.querySelectorAll("a[href]")).filter(t=>{const e=t.getAttribute("href");return e&&!e.startsWith("#")&&!e.startsWith("javascript:")&&!e.startsWith("mailto:")}).map(t=>({element:t,url:t.href,rect:t.getBoundingClientRect(),isVisible:this._isVisible(t)}))}_isVisible(t){const e=t.getBoundingClientRect();return e.top>=0&&e.left>=0&&e.bottom<=window.innerHeight&&e.right<=window.innerWidth&&e.width>0&&e.height>0}_calculateFittsScore(t,e,s){const n=Math.min(e,s);if(n<=0)return 0;const i=Math.log2(t/n+1);return Math.max(0,Math.min(100,100-i*15))}calculateScores(t){const e=performance.now();let s=80;if(navigator.connection&&(navigator.connection.saveData&&(s*=2),["slow-2g","2g","3g"].includes(navigator.connection.effectiveType)&&(s*=1.5)),navigator.getBattery&&!this.isCharging&&(s*=1.25),e-this.lastBatchTime<s||(this.lastBatchTime=e,window.instantNavTracker&&window.instantNavTracker.scrollSpeed>100))return;this._scanLinks();const n=[];for(const i of this.links){if(!i.isVisible)continue;const r=i.rect,o=r.left+r.width/2,a=r.top+r.height/2,h=o-t.position.x,g=a-t.position.y,l=Math.sqrt(h*h+g*g),u=this._calculateFittsScore(l,r.width,r.height),S=window.instantNavTracker.getIntentionScore(o,a),d=Math.max(0,S*100),y=Math.sqrt(window.innerWidth**2+window.innerHeight**2),w=Math.max(0,100-l/y*100),m=this._getContextScore(i.element),f=this._getHistoryScore(i.url),v=u*.3+d*.3+w*.15+m*.1+f*.15,T=this._getGraceBoost(i.url,v,t),_=Math.min(100,v+T);this.scores.set(i.url,{score:_,timestamp:e,breakdown:{fittsScore:u,intentionScore:d,proximityScore:w,contextScore:m,historyScore:f}}),n.push({url:i.url,element:i.element,score:_})}return n.sort((i,r)=>r.score-i.score),this._notifyPrefetcher(n.slice(0,5)),n}_getContextScore(t){return t.closest('main, article, [role="main"]')?80:t.closest('nav, footer, aside, [role="navigation"]')?30:50+(1-t.getBoundingClientRect().top/window.innerHeight)*30}_getHistoryScore(t){try{const e=new URL(t).hostname,s=window.location.hostname;return e===s?60:40}catch{return 40}}_getGraceBoost(t,e,s){if(s.speed<50&&e>50&&!this.graceTimers.has(t)){const n=this.scores.get(t);if(n&&n.score>e)return this.graceTimers.set(t,setTimeout(()=>{this.graceTimers.delete(t)},200)),n.score-e}return 0}_notifyPrefetcher(t){chrome.runtime.sendMessage({type:"PREDICTION_UPDATE",links:t.map(e=>({url:e.url,score:e.score}))})}getScore(t){var e;return((e=this.scores.get(t))==null?void 0:e.score)||0}}window.instantNavPredictor=new p,window.instantNavTracker.subscribe(c=>{window.instantNavPredictor.calculateScores(c)}),console.log("[InstantNav] Link Predictor initialized")})();
