(function(){"use strict";class b{constructor(){this.links=new Map,this.scores=new Map,this.graceTimers=new Map,this.historyCache=new Map,this.lastBatchTime=0,this._setupObserver(),this._initBatteryStatus(),this._setupIntersectionObserver()}async _initBatteryStatus(){if(navigator.getBattery)try{const t=await navigator.getBattery();this.isCharging=t.charging,t.addEventListener("chargingchange",()=>{this.isCharging=t.charging})}catch{this.isCharging=!0}else this.isCharging=!0}_setupObserver(){new MutationObserver(e=>{let s=!1;for(const i of e)if(i.addedNodes.length>0||i.removedNodes.length>0){s=!0;break}s&&this._scanLinks()}).observe(document.body,{childList:!0,subtree:!0}),this._scanLinks()}_setupIntersectionObserver(){this.intersectionObserver=new IntersectionObserver(t=>{for(const e of t){const s=this.links.get(e.target);s&&(s.isVisible=e.isIntersecting,e.isIntersecting&&(s.rect=e.boundingClientRect))}},{threshold:0})}_scanLinks(){const t=document.querySelectorAll("a[href]"),e=new Set(t);for(const[s,i]of this.links)e.has(s)||(this.intersectionObserver.unobserve(s),this.links.delete(s));for(const s of t){if(this.links.has(s))continue;const i=s.getAttribute("href");if(!i||i.startsWith("#")||i.startsWith("javascript:")||i.startsWith("mailto:"))continue;const r={element:s,url:s.href,rect:s.getBoundingClientRect(),isVisible:!1,score:0};this.links.set(s,r),this.intersectionObserver.observe(s),this._fetchHistoryScore(s.href)}}_calculateFittsScore(t,e,s){const i=Math.min(e,s);if(i<=0)return 0;const r=Math.log2(t/i+1);return Math.max(0,Math.min(100,100-r*15))}calculateScores(t){const e=performance.now();let s=80;if(navigator.connection&&(navigator.connection.saveData&&(s*=2),["slow-2g","2g","3g"].includes(navigator.connection.effectiveType)&&(s*=1.5)),navigator.getBattery&&!this.isCharging&&(s*=1.25),e-this.lastBatchTime<s||(this.lastBatchTime=e,window.instantNavTracker&&window.instantNavTracker.scrollSpeed>100))return;const i=[];for(const[r,n]of this.links){if(!n.isVisible)continue;const o=n.rect,h=o.left+o.width/2,g=o.top+o.height/2,l=h-t.position.x,f=g-t.position.y,u=l*l+f*f;if(u>25e4)continue;const d=Math.sqrt(u),v=this._calculateFittsScore(d,o.width,o.height),p=window.instantNavTracker.getIntentionScore(h,g),m=Math.max(0,p*100),k=Math.sqrt(window.innerWidth**2+window.innerHeight**2),w=Math.max(0,100-d/k*100),_=this._getContextScore(r),y=this._getHistoryScore(n.url),S=v*.3+m*.3+w*.15+_*.1+y*.15,C=this._getGraceBoost(n.url,S,t),c=Math.min(100,S+C);n.score=c,c>30&&(this.scores.set(n.url,{score:c,timestamp:e,breakdown:{fittsScore:v,intentionScore:m,proximityScore:w,contextScore:_,historyScore:y}}),i.push({url:n.url,element:r,score:c}))}return i.sort((r,n)=>n.score-r.score),i.length>0&&this._notifyPrefetcher(i.slice(0,5)),i}_getContextScore(t){return t.closest('main, article, [role="main"]')?80:t.closest('nav, footer, aside, [role="navigation"]')?30:50+(1-t.getBoundingClientRect().top/window.innerHeight)*30}_getHistoryScore(t){return this.historyCache.has(t)?this.historyCache.get(t):40}_fetchHistoryScore(t){if(!this.historyCache.has(t)){this.historyCache.set(t,40);try{chrome.runtime.sendMessage({type:"GET_HISTORY_SCORE",url:t},e=>{e&&e.score&&this.historyCache.set(t,e.score)})}catch{}}}_getGraceBoost(t,e,s){if(s.speed<50&&e>50&&!this.graceTimers.has(t)){const i=this.scores.get(t);if(i&&i.score>e)return this.graceTimers.set(t,setTimeout(()=>{this.graceTimers.delete(t)},200)),i.score-e}return 0}_notifyPrefetcher(t){chrome.runtime.sendMessage({type:"PREDICTION_UPDATE",links:t.map(e=>({url:e.url,score:e.score}))})}getScore(t){var e;return((e=this.scores.get(t))==null?void 0:e.score)||0}}window.instantNavPredictor=new b,window.instantNavTracker.subscribe(a=>{window.instantNavPredictor.calculateScores(a)}),console.log("[InstantNav] Link Predictor initialized")})();
