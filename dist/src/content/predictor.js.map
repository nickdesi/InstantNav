{"version":3,"file":"predictor.js","sources":["../../../src/content/predictor.js"],"sourcesContent":["/**\n * InstantNav - Link Predictor\n * Calculates click probability scores using Fitts' Law and intention vectors\n */\n\nconst GRACE_PERIOD_MS = 200;\nconst BATCH_INTERVAL_MS = 80;\n\nclass LinkPredictor {\n    constructor() {\n        this.links = [];\n        this.scores = new Map(); // URL -> { score, timestamp }\n        this.graceTimers = new Map(); // URL -> timeout\n        this.lastBatchTime = 0;\n\n        this._setupObserver();\n        this._initBatteryStatus();\n        this._scanLinks();\n    }\n\n    async _initBatteryStatus() {\n        if (navigator.getBattery) {\n            try {\n                const battery = await navigator.getBattery();\n                this.isCharging = battery.charging;\n                battery.addEventListener('chargingchange', () => {\n                    this.isCharging = battery.charging;\n                });\n            } catch (e) {\n                this.isCharging = true; // Assume plugged in if error\n            }\n        } else {\n            this.isCharging = true;\n        }\n    }\n\n    _setupObserver() {\n        // Watch for DOM changes to detect new links\n        const observer = new MutationObserver(() => {\n            this._scanLinks();\n        });\n\n        observer.observe(document.body, {\n            childList: true,\n            subtree: true\n        });\n    }\n\n    _scanLinks() {\n        this.links = Array.from(document.querySelectorAll('a[href]'))\n            .filter(link => {\n                const href = link.getAttribute('href');\n                return href &&\n                    !href.startsWith('#') &&\n                    !href.startsWith('javascript:') &&\n                    !href.startsWith('mailto:');\n            })\n            .map(link => ({\n                element: link,\n                url: link.href,\n                rect: link.getBoundingClientRect(),\n                isVisible: this._isVisible(link)\n            }));\n    }\n\n    _isVisible(element) {\n        const rect = element.getBoundingClientRect();\n        return (\n            rect.top >= 0 &&\n            rect.left >= 0 &&\n            rect.bottom <= window.innerHeight &&\n            rect.right <= window.innerWidth &&\n            rect.width > 0 &&\n            rect.height > 0\n        );\n    }\n\n    /**\n     * Fitts' Law Score (inverted)\n     * Lower ID = easier click = higher score\n     */\n    _calculateFittsScore(distance, width, height) {\n        const minDimension = Math.min(width, height);\n        if (minDimension <= 0) return 0;\n\n        const id = Math.log2(distance / minDimension + 1);\n        const k = 15; // Normalization factor\n        const score = Math.max(0, Math.min(100, 100 - id * k));\n\n        return score;\n    }\n\n    /**\n     * Calculate all scores for visible links\n     */\n    calculateScores(cursorData) {\n        const now = performance.now();\n\n        // Dynamic throttling based on environment\n        let currentInterval = BATCH_INTERVAL_MS;\n\n        // 1. Network check\n        if (navigator.connection) {\n            if (navigator.connection.saveData) currentInterval *= 2; // 160ms\n            if (['slow-2g', '2g', '3g'].includes(navigator.connection.effectiveType)) currentInterval *= 1.5; // 120ms\n        }\n\n        // 2. Battery check (if API available)\n        if (navigator.getBattery && !this.isCharging) {\n            currentInterval *= 1.25; // 100ms\n        }\n\n        // Throttle heavy calculations\n        if (now - this.lastBatchTime < currentInterval) return;\n        this.lastBatchTime = now;\n\n        // Skip calculations if user is scrolling fast (high noise)\n        if (window.instantNavTracker && window.instantNavTracker.scrollSpeed > 100) {\n            return;\n        }\n\n        // Refresh link positions if viewport changed\n        this._scanLinks();\n\n        const results = [];\n\n        for (const link of this.links) {\n            if (!link.isVisible) continue;\n\n            const rect = link.rect;\n            const centerX = rect.left + rect.width / 2;\n            const centerY = rect.top + rect.height / 2;\n\n            // Distance from cursor to link center\n            const dx = centerX - cursorData.position.x;\n            const dy = centerY - cursorData.position.y;\n            const distance = Math.sqrt(dx * dx + dy * dy);\n\n            // 1. Fitts Score (30%)\n            const fittsScore = this._calculateFittsScore(distance, rect.width, rect.height);\n\n            // 2. Intention Vector Score (30%)\n            const intentionRaw = window.instantNavTracker.getIntentionScore(centerX, centerY);\n            const intentionScore = Math.max(0, intentionRaw * 100); // 0-100\n\n            // 3. Proximity Score (15%)\n            const maxDistance = Math.sqrt(window.innerWidth ** 2 + window.innerHeight ** 2);\n            const proximityScore = Math.max(0, 100 - (distance / maxDistance) * 100);\n\n            // 4. Context Score (10%) - prioritize main content over footer/sidebar\n            const contextScore = this._getContextScore(link.element);\n\n            // 5. History Score (15%) - placeholder for learning engine\n            const historyScore = this._getHistoryScore(link.url);\n\n            // Weighted total\n            const totalScore =\n                fittsScore * 0.30 +\n                intentionScore * 0.30 +\n                proximityScore * 0.15 +\n                contextScore * 0.10 +\n                historyScore * 0.15;\n\n            // Apply grace period boost if cursor stopped near link\n            const graceBoost = this._getGraceBoost(link.url, totalScore, cursorData);\n            const finalScore = Math.min(100, totalScore + graceBoost);\n\n            this.scores.set(link.url, {\n                score: finalScore,\n                timestamp: now,\n                breakdown: { fittsScore, intentionScore, proximityScore, contextScore, historyScore }\n            });\n\n            results.push({\n                url: link.url,\n                element: link.element,\n                score: finalScore\n            });\n        }\n\n        // Sort by score descending\n        results.sort((a, b) => b.score - a.score);\n\n        // Notify prefetcher with top candidates\n        this._notifyPrefetcher(results.slice(0, 5));\n\n\n\n        return results;\n    }\n\n    _getContextScore(element) {\n        // Check if link is in main content vs navigation/footer\n        const parent = element.closest('main, article, [role=\"main\"]');\n        if (parent) return 80;\n\n        const nav = element.closest('nav, footer, aside, [role=\"navigation\"]');\n        if (nav) return 30;\n\n        // Check position in viewport (top = more likely to click)\n        const rect = element.getBoundingClientRect();\n        const viewportPosition = rect.top / window.innerHeight;\n        return 50 + (1 - viewportPosition) * 30;\n    }\n\n    _getHistoryScore(url) {\n        // Placeholder - will be enhanced by Learning Engine\n        // For now, give slight boost to same-domain links\n        try {\n            const linkDomain = new URL(url).hostname;\n            const currentDomain = window.location.hostname;\n            return linkDomain === currentDomain ? 60 : 40;\n        } catch {\n            return 40;\n        }\n    }\n\n    _getGraceBoost(url, currentScore, cursorData) {\n        // Grace Period: maintain score for 200ms after cursor stops near link\n        if (cursorData.speed < 50 && currentScore > 50) {\n            // Cursor almost stopped and score is decent\n            if (!this.graceTimers.has(url)) {\n                const existingScore = this.scores.get(url);\n                if (existingScore && existingScore.score > currentScore) {\n                    // Start grace period\n                    this.graceTimers.set(url, setTimeout(() => {\n                        this.graceTimers.delete(url);\n                    }, GRACE_PERIOD_MS));\n                    return existingScore.score - currentScore; // Boost to maintain previous score\n                }\n            }\n        }\n        return 0;\n    }\n\n    _notifyPrefetcher(topLinks) {\n        // Send to background script for prefetching\n        chrome.runtime.sendMessage({\n            type: 'PREDICTION_UPDATE',\n            links: topLinks.map(l => ({\n                url: l.url,\n                score: l.score\n            }))\n        });\n    }\n\n    getScore(url) {\n        return this.scores.get(url)?.score || 0;\n    }\n}\n\n// Initialize and connect to tracker\nwindow.instantNavPredictor = new LinkPredictor();\n\n// Subscribe to cursor updates\nwindow.instantNavTracker.subscribe((data) => {\n    window.instantNavPredictor.calculateScores(data);\n});\n\nconsole.log('[InstantNav] Link Predictor initialized');\n"],"names":["LinkPredictor","battery","link","href","element","rect","distance","width","height","minDimension","id","cursorData","now","currentInterval","results","centerX","centerY","dx","dy","fittsScore","intentionRaw","intentionScore","maxDistance","proximityScore","contextScore","historyScore","totalScore","graceBoost","finalScore","a","b","url","linkDomain","currentDomain","currentScore","existingScore","topLinks","l","_a","data"],"mappings":"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"}