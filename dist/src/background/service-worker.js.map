{"version":3,"file":"service-worker.js","sources":["../../../src/background/prefetcher.js","../../../src/background/context-manager.js","../../../src/utils/trust-list.js","../../../src/background/service-worker.js"],"sourcesContent":["/**\n * InstantNav - Prefetcher\n * Uses Speculation Rules API for advanced prefetching and prerendering\n */\n\nexport class Prefetcher {\n    constructor() {\n        this.prefetchedUrls = new Map(); // url -> { type, timestamp }\n        this.activeSpeculationRules = [];\n        this.maxRules = 10; // Prevent memory bloat\n        this._loadState();\n    }\n\n    async _loadState() {\n        try {\n            const result = await chrome.storage.local.get('prefetchState');\n            if (result.prefetchState) {\n                // Deserialize Map\n                this.prefetchedUrls = new Map(Object.entries(result.prefetchState.urls || {}));\n                this.activeSpeculationRules = result.prefetchState.rules || [];\n            }\n        } catch (e) {\n            console.error('[InstantNav] Failed to load prefetch state:', e);\n        }\n    }\n\n    async _saveState() {\n        try {\n            await chrome.storage.local.set({\n                prefetchState: {\n                    urls: Object.fromEntries(this.prefetchedUrls),\n                    rules: this.activeSpeculationRules\n                }\n            });\n        } catch (e) {\n            console.error('[InstantNav] Failed to save prefetch state:', e);\n        }\n    }\n\n    /**\n     * DNS Prefetch - Lightest, just resolves DNS\n     */\n    async dnsPrefetch(url) {\n        try {\n            const domain = new URL(url).origin;\n\n            // Inject link element via content script\n            this._injectLinkHint(domain, 'dns-prefetch');\n\n            this._track(url, 'dns-prefetch');\n        } catch (e) {\n            console.warn('[InstantNav] DNS prefetch failed:', e);\n        }\n    }\n\n    /**\n     * Preconnect - DNS + TCP + TLS handshake\n     */\n    async preconnect(url) {\n        try {\n            const domain = new URL(url).origin;\n\n            this._injectLinkHint(domain, 'preconnect');\n\n            this._track(url, 'preconnect');\n        } catch (e) {\n            console.warn('[InstantNav] Preconnect failed:', e);\n        }\n    }\n\n    /**\n     * Prefetch - Downloads HTML document\n     */\n    async prefetch(url, tabId) {\n        if (this.prefetchedUrls.has(url)) return;\n\n        try {\n            // Respect user's data saving preference\n            if (navigator.connection && navigator.connection.saveData) {\n                return;\n            }\n\n            // Use Speculation Rules API if available\n            await this._addSpeculationRule(tabId, 'prefetch', url);\n\n            this._track(url, 'prefetch');\n        } catch (e) {\n            console.warn('[InstantNav] Prefetch failed:', e);\n        }\n    }\n\n    /**\n     * Prerender - Full page render in background\n     */\n    async prerender(url, tabId) {\n        if (this.prefetchedUrls.has(url)) return;\n\n        try {\n            // Respect user's data saving preference\n            if (navigator.connection && navigator.connection.saveData) {\n                return;\n            }\n\n            // Use Speculation Rules API for prerender\n            await this._addSpeculationRule(tabId, 'prerender', url);\n\n            this._track(url, 'prerender');\n        } catch (e) {\n            console.warn('[InstantNav] Prerender failed:', e);\n        }\n    }\n\n    /**\n     * Add Speculation Rules via content script injection\n     */\n    async _addSpeculationRule(tabId, type, url) {\n        // Clean up old rules to prevent memory bloat\n        if (this.activeSpeculationRules.length >= this.maxRules) {\n            await this._removeOldestRule(tabId);\n        }\n\n        const rule = {\n            [type]: [{\n                source: 'list',\n                urls: [url],\n                eagerness: type === 'prerender' ? 'moderate' : 'eager'\n            }]\n        };\n\n        // Inject speculation rules script into page\n        await chrome.scripting.executeScript({\n            target: { tabId },\n            func: (ruleJson) => {\n                // Remove existing speculation rules with same URL\n                const existingScripts = document.querySelectorAll('script[type=\"speculationrules\"][data-instantnav]');\n                existingScripts.forEach(s => {\n                    try {\n                        const rules = JSON.parse(s.textContent);\n                        const hasUrl = Object.values(rules).flat().some(r => r.urls?.includes(ruleJson.url));\n                        if (hasUrl) s.remove();\n                    } catch { }\n                });\n\n                // Add new speculation rules\n                const script = document.createElement('script');\n                script.type = 'speculationrules';\n                script.setAttribute('data-instantnav', 'true');\n                script.textContent = JSON.stringify(ruleJson.rule);\n                document.head.appendChild(script);\n            },\n            args: [{ rule, url }]\n        });\n\n        this.activeSpeculationRules.push({ type, url, timestamp: Date.now() });\n        this._saveState();\n    }\n\n    async _removeOldestRule(tabId) {\n        const oldest = this.activeSpeculationRules.shift();\n        if (!oldest) return;\n\n        try {\n            await chrome.scripting.executeScript({\n                target: { tabId },\n                func: (urlToRemove) => {\n                    const scripts = document.querySelectorAll('script[type=\"speculationrules\"][data-instantnav]');\n                    scripts.forEach(s => {\n                        try {\n                            const content = s.textContent;\n                            if (content.includes(urlToRemove)) {\n                                s.remove();\n                            }\n                        } catch { }\n                    });\n                },\n                args: [oldest.url]\n            });\n        } catch (e) {\n            console.warn('[InstantNav] Failed to remove old rule:', e);\n        }\n\n        this.prefetchedUrls.delete(oldest.url);\n    }\n\n    _injectLinkHint(href, rel) {\n        // This will be injected via content script\n        chrome.tabs.query({ active: true, currentWindow: true }, (tabs) => {\n            if (!tabs[0]?.id) return;\n\n            chrome.scripting.executeScript({\n                target: { tabId: tabs[0].id },\n                func: (href, rel) => {\n                    // Check if already exists\n                    if (document.querySelector(`link[rel=\"${rel}\"][href=\"${href}\"]`)) return;\n\n                    const link = document.createElement('link');\n                    link.rel = rel;\n                    link.href = href;\n                    document.head.appendChild(link);\n                },\n                args: [href, rel]\n            });\n        });\n    }\n\n    _normalize(url) {\n        try {\n            const u = new URL(url);\n            // Remove trailing slash\n            let path = u.pathname;\n            if (path.endsWith('/') && path.length > 1) {\n                path = path.slice(0, -1);\n            }\n            return u.origin + path + u.search;\n        } catch {\n            return url;\n        }\n    }\n\n    _track(url, type) {\n        this.prefetchedUrls.set(this._normalize(url), { type, timestamp: Date.now() });\n        this._saveState();\n    }\n\n    wasPrefetched(url) {\n        return this.prefetchedUrls.has(this._normalize(url));\n    }\n\n    getPrefetchType(url) {\n        return this.prefetchedUrls.get(this._normalize(url))?.type;\n    }\n\n    clearOldPrefetches(maxAgeMs = 60000) {\n        const now = Date.now();\n        let changed = false;\n        for (const [url, data] of this.prefetchedUrls) {\n            if (now - data.timestamp > maxAgeMs) {\n                this.prefetchedUrls.delete(url);\n                changed = true;\n            }\n        }\n        if (changed) this._saveState();\n    }\n}\n","/**\n * InstantNav - Context Manager\n * Adapts prefetching behavior based on battery, network, and RAM\n */\n\nexport class ContextManager {\n    constructor() {\n        this.currentMode = 'auto'; // 'turbo', 'balanced', 'eco', 'auto'\n        this.contextData = {\n            battery: { charging: true, level: 1 },\n            network: { type: 'wifi', downlink: 10 },\n            memory: { usedPercent: 0.5 }\n        };\n\n        this.profiles = {\n            turbo: {\n                maxPrerender: 3,\n                maxPrefetch: 10,\n                prerenderThreshold: 70,\n                prefetchThreshold: 50,\n                preconnectThreshold: 30\n            },\n            balanced: {\n                maxPrerender: 1,\n                maxPrefetch: 5,\n                prerenderThreshold: 80,\n                prefetchThreshold: 60,\n                preconnectThreshold: 40\n            },\n            eco: {\n                maxPrerender: 0,\n                maxPrefetch: 2,\n                prerenderThreshold: 100, // Never prerender\n                prefetchThreshold: 85,\n                preconnectThreshold: 70\n            }\n        };\n\n        this._startMonitoring();\n    }\n\n    async _startMonitoring() {\n        // Monitor battery\n        if ('getBattery' in navigator) {\n            try {\n                const battery = await navigator.getBattery();\n                this._updateBattery(battery);\n\n                battery.addEventListener('chargingchange', () => this._updateBattery(battery));\n                battery.addEventListener('levelchange', () => this._updateBattery(battery));\n            } catch (e) {\n                console.warn('[InstantNav] Battery API not available');\n            }\n        }\n\n        // Monitor network\n        if ('connection' in navigator) {\n            const conn = navigator.connection;\n            this._updateNetwork(conn);\n\n            conn.addEventListener('change', () => this._updateNetwork(conn));\n        }\n\n        // Monitor memory periodically\n        this._checkMemory();\n        setInterval(() => this._checkMemory(), 30000); // Every 30s\n    }\n\n    _updateBattery(battery) {\n        this.contextData.battery = {\n            charging: battery.charging,\n            level: battery.level\n        };\n        this._recalculateMode();\n    }\n\n    _updateNetwork(connection) {\n        this.contextData.network = {\n            type: connection.effectiveType || 'unknown',\n            downlink: connection.downlink || 10,\n            saveData: connection.saveData || false\n        };\n        this._recalculateMode();\n    }\n\n    _checkMemory() {\n        if ('memory' in performance) {\n            const { usedJSHeapSize, jsHeapSizeLimit } = performance.memory;\n            this.contextData.memory = {\n                usedPercent: usedJSHeapSize / jsHeapSizeLimit\n            };\n            this._recalculateMode();\n        }\n    }\n\n    _recalculateMode() {\n        if (this.currentMode !== 'auto') return;\n\n        const { battery, network, memory } = this.contextData;\n\n        // Determine effective mode based on context\n        let effectiveMode = 'balanced';\n\n        // Eco conditions\n        if (\n            (!battery.charging && battery.level < 0.2) ||\n            network.saveData ||\n            network.type === '2g' ||\n            network.type === 'slow-2g' ||\n            memory.usedPercent > 0.8\n        ) {\n            effectiveMode = 'eco';\n        }\n\n        // Turbo conditions\n        else if (\n            battery.charging &&\n            (network.type === '4g' || network.downlink > 5) &&\n            memory.usedPercent < 0.5\n        ) {\n            effectiveMode = 'turbo';\n        }\n\n        this._effectiveMode = effectiveMode;\n    }\n\n    setMode(mode) {\n        if (['turbo', 'balanced', 'eco', 'auto'].includes(mode)) {\n            this.currentMode = mode;\n            chrome.storage.local.set({ prefetchMode: mode });\n            this._recalculateMode();\n        }\n    }\n\n    getProfile() {\n        const mode = this.currentMode === 'auto'\n            ? (this._effectiveMode || 'balanced')\n            : this.currentMode;\n\n        return this.profiles[mode];\n    }\n\n    getStatus() {\n        return {\n            mode: this.currentMode,\n            effectiveMode: this._effectiveMode || this.currentMode,\n            context: this.contextData,\n            profile: this.getProfile()\n        };\n    }\n}\n","/**\n * InstantNav - Trust List Manager\n * Manages site trust levels for privacy-aware prefetching\n */\n\nconst DEFAULT_TRUSTED = [\n    'github.com',\n    'stackoverflow.com',\n    'wikipedia.org',\n    'youtube.com',\n    'reddit.com'\n];\n\nconst KNOWN_TRACKERS = [\n    'doubleclick.net',\n    'googlesyndication.com',\n    'facebook.net',\n    'analytics.google.com'\n];\n\nconst BLACKLISTED = [\n    'google.com',\n    'www.google.com',\n    'accounts.google.com',\n    'myaccount.google.com',\n    'recaptcha.net',\n    'bankofamerica.com',\n    'chase.com',\n    'paypal.com'\n];\n\nclass TrustList {\n    constructor() {\n        this.trustLevels = {}; // domain -> 'trusted' | 'neutral' | 'untrusted'\n        this.load();\n    }\n\n    async load() {\n        try {\n            const result = await chrome.storage.local.get('trustLevels');\n            this.trustLevels = result.trustLevels || {};\n        } catch (e) {\n            this.trustLevels = {};\n        }\n    }\n\n    async save() {\n        await chrome.storage.local.set({ trustLevels: this.trustLevels });\n    }\n\n    /**\n     * Get trust level for a domain\n     * Returns: 'trusted', 'neutral', or 'untrusted'\n     */\n    getTrustLevel(url) {\n        try {\n            const domain = this._extractDomain(url);\n\n            // Check explicit settings first\n            if (this.trustLevels[domain]) {\n                return this.trustLevels[domain];\n            }\n\n            // Check known trackers\n            if (this._isKnownTracker(domain)) {\n                return 'untrusted';\n            }\n\n            // Check blacklisted (sensitive/rate-limited)\n            if (this._isBlacklisted(domain)) {\n                return 'untrusted';\n            }\n\n            // Check default trusted\n            if (this._isDefaultTrusted(domain)) {\n                return 'trusted';\n            }\n\n            return 'neutral';\n        } catch {\n            return 'neutral';\n        }\n    }\n\n    /**\n     * Set trust level for a domain\n     */\n    async setTrustLevel(url, level) {\n        const domain = this._extractDomain(url);\n        this.trustLevels[domain] = level;\n        await this.save();\n    }\n\n    /**\n     * Check if prefetch/prerender is allowed for this URL\n     */\n    canPrefetch(url) {\n        const level = this.getTrustLevel(url);\n        return level === 'trusted' || level === 'neutral';\n    }\n\n    canPrerender(url) {\n        const level = this.getTrustLevel(url);\n        return level === 'trusted';\n    }\n\n    /**\n     * Promote a domain to trusted after multiple visits\n     */\n    async promoteIfFrequent(domain, visitCount) {\n        if (visitCount >= 10 && this.getTrustLevel(domain) === 'neutral') {\n            this.trustLevels[domain] = 'trusted';\n            await this.save();\n            return true;\n        }\n        return false;\n    }\n\n    _extractDomain(url) {\n        try {\n            const hostname = new URL(url).hostname;\n            // Remove www. prefix\n            return hostname.replace(/^www\\./, '');\n        } catch {\n            return url;\n        }\n    }\n\n    _isKnownTracker(domain) {\n        return KNOWN_TRACKERS.some(tracker =>\n            domain === tracker || domain.endsWith(`.${tracker}`)\n        );\n    }\n\n    _isBlacklisted(domain) {\n        return BLACKLISTED.some(blocked =>\n            domain === blocked || domain.endsWith(`.${blocked}`)\n        );\n    }\n\n    _isDefaultTrusted(domain) {\n        return DEFAULT_TRUSTED.some(trusted =>\n            domain === trusted || domain.endsWith(`.${trusted}`)\n        );\n    }\n\n    /**\n     * Get all manually set trust levels\n     */\n    getAll() {\n        return { ...this.trustLevels };\n    }\n\n    /**\n     * Reset to defaults\n     */\n    async reset() {\n        this.trustLevels = {};\n        await this.save();\n    }\n}\n\nexport const trustList = new TrustList();\n","/**\n * InstantNav - Service Worker\n * Background script coordinating prefetching and context management\n */\n\nimport { Prefetcher } from './prefetcher.js';\nimport { ContextManager } from './context-manager.js';\nimport { trustList } from '../utils/trust-list.js';\n\nclass InstantNavService {\n    constructor() {\n        this.prefetcher = new Prefetcher();\n        this.contextManager = new ContextManager();\n        this.stats = {\n            totalPrefetches: 0,\n            successfulPredictions: 0,\n            timeSaved: 0,\n            startTime: Date.now()\n        };\n\n        this._setupMessageListener();\n        this._setupTabListener();\n        this._loadStats();\n    }\n\n    _setupMessageListener() {\n        chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {\n            switch (message.type) {\n                case 'PREDICTION_UPDATE':\n                    this._handlePredictions(message.links, sender.tab?.id);\n                    break;\n\n                case 'GET_STATS':\n                    sendResponse(this.stats);\n                    break;\n\n                case 'GET_MODE':\n                    sendResponse({ mode: this.contextManager.currentMode });\n                    break;\n\n                case 'SET_MODE':\n                    this.contextManager.setMode(message.mode);\n                    break;\n\n                case 'NAVIGATION_COMPLETE':\n                    this._trackSuccessfulPrediction(message.url, message.loadTime);\n                    break;\n            }\n            return true;\n        });\n    }\n\n    _setupTabListener() {\n        // Track when user actually navigates to a prefetched page\n        chrome.webNavigation?.onCompleted?.addListener((details) => {\n            if (details.frameId !== 0) return; // Main frame only\n\n            const wasPrefetched = this.prefetcher.wasPrefetched(details.url);\n            console.log('[InstantNav] Navigated to:', details.url, 'Was prefetched?', wasPrefetched);\n\n            if (wasPrefetched) {\n                this.stats.successfulPredictions++;\n                this._saveStats();\n            }\n        });\n    }\n\n    async _handlePredictions(links, tabId) {\n        const profile = this.contextManager.getProfile();\n        let statsUpdated = false;\n\n        for (const link of links) {\n            // Check trust list first\n            if (!trustList.canPrefetch(link.url)) continue;\n\n            if (link.score >= profile.prerenderThreshold && profile.maxPrerender > 0) {\n                if (trustList.canPrerender(link.url)) {\n                    await this.prefetcher.prerender(link.url, tabId);\n                    this.stats.totalPrefetches++;\n                    statsUpdated = true;\n                } else {\n                    // Downgrade to prefetch if prerender not allowed\n                    await this.prefetcher.prefetch(link.url, tabId);\n                    this.stats.totalPrefetches++;\n                    statsUpdated = true;\n                }\n            } else if (link.score >= profile.prefetchThreshold && profile.maxPrefetch > 0) {\n                await this.prefetcher.prefetch(link.url, tabId);\n                this.stats.totalPrefetches++;\n                statsUpdated = true;\n            } else if (link.score >= profile.preconnectThreshold) {\n                await this.prefetcher.preconnect(link.url);\n            } else if (link.score >= 30) {\n                await this.prefetcher.dnsPrefetch(link.url);\n            }\n        }\n\n        if (statsUpdated) {\n            this._saveStats();\n        }\n    }\n\n    _trackSuccessfulPrediction(url, loadTime) {\n        // Estimate time saved (average page load without prefetch: 2s)\n        const estimatedSavings = Math.max(0, 2000 - loadTime);\n        this.stats.timeSaved += estimatedSavings;\n        this._saveStats();\n    }\n\n    async _loadStats() {\n        try {\n            const result = await chrome.storage.local.get('stats');\n            if (result.stats) {\n                this.stats = { ...this.stats, ...result.stats };\n            }\n        } catch (e) {\n            console.error('[InstantNav] Failed to load stats:', e);\n        }\n    }\n\n    async _saveStats() {\n        try {\n            await chrome.storage.local.set({ stats: this.stats });\n        } catch (e) {\n            console.error('[InstantNav] Failed to save stats:', e);\n        }\n    }\n}\n\n// Initialize service\nconst service = new InstantNavService();\nconsole.log('[InstantNav] Service Worker initialized');\n"],"names":["Prefetcher","result","url","domain","e","tabId","type","rule","ruleJson","s","rules","r","_a","script","oldest","urlToRemove","href","rel","tabs","link","u","path","maxAgeMs","now","changed","data","ContextManager","battery","conn","connection","usedJSHeapSize","jsHeapSizeLimit","network","memory","effectiveMode","mode","DEFAULT_TRUSTED","KNOWN_TRACKERS","BLACKLISTED","TrustList","level","visitCount","tracker","blocked","trusted","trustList","InstantNavService","message","sender","sendResponse","_b","details","wasPrefetched","links","profile","statsUpdated","loadTime","estimatedSavings"],"mappings":"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"}