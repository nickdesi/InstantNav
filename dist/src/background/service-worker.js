(function(){"use strict";class u{constructor(){this.prefetchedUrls=new Map,this.activeSpeculationRules=[],this.maxRules=10}async dnsPrefetch(e){try{const t=new URL(e).origin;this._injectLinkHint(t,"dns-prefetch"),this._track(e,"dns-prefetch")}catch(t){console.warn("[InstantNav] DNS prefetch failed:",t)}}async preconnect(e){try{const t=new URL(e).origin;this._injectLinkHint(t,"preconnect"),this._track(e,"preconnect")}catch(t){console.warn("[InstantNav] Preconnect failed:",t)}}async prefetch(e,t){if(!this.prefetchedUrls.has(e))try{if(navigator.connection&&navigator.connection.saveData)return;await this._addSpeculationRule(t,"prefetch",e),this._track(e,"prefetch")}catch(r){console.warn("[InstantNav] Prefetch failed:",r)}}async prerender(e,t){if(!this.prefetchedUrls.has(e))try{if(navigator.connection&&navigator.connection.saveData)return;await this._addSpeculationRule(t,"prerender",e),this._track(e,"prerender")}catch(r){console.warn("[InstantNav] Prerender failed:",r)}}async _addSpeculationRule(e,t,r){this.activeSpeculationRules.length>=this.maxRules&&await this._removeOldestRule(e);const s={[t]:[{source:"list",urls:[r],eagerness:t==="prerender"?"moderate":"eager"}]};await chrome.scripting.executeScript({target:{tabId:e},func:a=>{document.querySelectorAll('script[type="speculationrules"][data-instantnav]').forEach(h=>{try{const w=JSON.parse(h.textContent);Object.values(w).flat().some(y=>{var l;return(l=y.urls)==null?void 0:l.includes(a.url)})&&h.remove()}catch{}});const n=document.createElement("script");n.type="speculationrules",n.setAttribute("data-instantnav","true"),n.textContent=JSON.stringify(a.rule),document.head.appendChild(n)},args:[{rule:s,url:r}]}),this.activeSpeculationRules.push({type:t,url:r,timestamp:Date.now()})}async _removeOldestRule(e){const t=this.activeSpeculationRules.shift();if(t){try{await chrome.scripting.executeScript({target:{tabId:e},func:r=>{document.querySelectorAll('script[type="speculationrules"][data-instantnav]').forEach(a=>{try{a.textContent.includes(r)&&a.remove()}catch{}})},args:[t.url]})}catch(r){console.warn("[InstantNav] Failed to remove old rule:",r)}this.prefetchedUrls.delete(t.url)}}_injectLinkHint(e,t){chrome.tabs.query({active:!0,currentWindow:!0},r=>{var s;(s=r[0])!=null&&s.id&&chrome.scripting.executeScript({target:{tabId:r[0].id},func:(a,c)=>{if(document.querySelector(`link[rel="${c}"][href="${a}"]`))return;const n=document.createElement("link");n.rel=c,n.href=a,document.head.appendChild(n)},args:[e,t]})})}_normalize(e){try{const t=new URL(e);let r=t.pathname;return r.endsWith("/")&&r.length>1&&(r=r.slice(0,-1)),t.origin+r+t.search}catch{return e}}_track(e,t){this.prefetchedUrls.set(this._normalize(e),{type:t,timestamp:Date.now()})}wasPrefetched(e){return this.prefetchedUrls.has(this._normalize(e))}getPrefetchType(e){var t;return(t=this.prefetchedUrls.get(this._normalize(e)))==null?void 0:t.type}clearOldPrefetches(e=6e4){const t=Date.now();for(const[r,s]of this.prefetchedUrls)t-s.timestamp>e&&this.prefetchedUrls.delete(r)}}class d{constructor(){this.currentMode="auto",this.contextData={battery:{charging:!0,level:1},network:{type:"wifi",downlink:10},memory:{usedPercent:.5}},this.profiles={turbo:{maxPrerender:3,maxPrefetch:10,prerenderThreshold:70,prefetchThreshold:50,preconnectThreshold:30},balanced:{maxPrerender:1,maxPrefetch:5,prerenderThreshold:80,prefetchThreshold:60,preconnectThreshold:40},eco:{maxPrerender:0,maxPrefetch:2,prerenderThreshold:100,prefetchThreshold:85,preconnectThreshold:70}},this._startMonitoring()}async _startMonitoring(){if("getBattery"in navigator)try{const e=await navigator.getBattery();this._updateBattery(e),e.addEventListener("chargingchange",()=>this._updateBattery(e)),e.addEventListener("levelchange",()=>this._updateBattery(e))}catch{console.warn("[InstantNav] Battery API not available")}if("connection"in navigator){const e=navigator.connection;this._updateNetwork(e),e.addEventListener("change",()=>this._updateNetwork(e))}this._checkMemory(),setInterval(()=>this._checkMemory(),3e4)}_updateBattery(e){this.contextData.battery={charging:e.charging,level:e.level},this._recalculateMode()}_updateNetwork(e){this.contextData.network={type:e.effectiveType||"unknown",downlink:e.downlink||10,saveData:e.saveData||!1},this._recalculateMode()}_checkMemory(){if("memory"in performance){const{usedJSHeapSize:e,jsHeapSizeLimit:t}=performance.memory;this.contextData.memory={usedPercent:e/t},this._recalculateMode()}}_recalculateMode(){if(this.currentMode!=="auto")return;const{battery:e,network:t,memory:r}=this.contextData;let s="balanced";!e.charging&&e.level<.2||t.saveData||t.type==="2g"||t.type==="slow-2g"||r.usedPercent>.8?s="eco":e.charging&&(t.type==="4g"||t.downlink>5)&&r.usedPercent<.5&&(s="turbo"),this._effectiveMode=s}setMode(e){["turbo","balanced","eco","auto"].includes(e)&&(this.currentMode=e,chrome.storage.local.set({prefetchMode:e}),this._recalculateMode())}getProfile(){const e=this.currentMode==="auto"?this._effectiveMode||"balanced":this.currentMode;return this.profiles[e]}getStatus(){return{mode:this.currentMode,effectiveMode:this._effectiveMode||this.currentMode,context:this.contextData,profile:this.getProfile()}}}const f=["github.com","stackoverflow.com","wikipedia.org","youtube.com","reddit.com"],p=["doubleclick.net","googlesyndication.com","facebook.net","analytics.google.com"],m=["google.com","www.google.com","accounts.google.com","myaccount.google.com","recaptcha.net","bankofamerica.com","chase.com","paypal.com"];class v{constructor(){this.trustLevels={},this.load()}async load(){try{const e=await chrome.storage.local.get("trustLevels");this.trustLevels=e.trustLevels||{}}catch{this.trustLevels={}}}async save(){await chrome.storage.local.set({trustLevels:this.trustLevels})}getTrustLevel(e){try{const t=this._extractDomain(e);return this.trustLevels[t]?this.trustLevels[t]:this._isKnownTracker(t)||this._isBlacklisted(t)?"untrusted":this._isDefaultTrusted(t)?"trusted":"neutral"}catch{return"neutral"}}async setTrustLevel(e,t){const r=this._extractDomain(e);this.trustLevels[r]=t,await this.save()}canPrefetch(e){const t=this.getTrustLevel(e);return t==="trusted"||t==="neutral"}canPrerender(e){return this.getTrustLevel(e)==="trusted"}async promoteIfFrequent(e,t){return t>=10&&this.getTrustLevel(e)==="neutral"?(this.trustLevels[e]="trusted",await this.save(),!0):!1}_extractDomain(e){try{return new URL(e).hostname.replace(/^www\./,"")}catch{return e}}_isKnownTracker(e){return p.some(t=>e===t||e.endsWith(`.${t}`))}_isBlacklisted(e){return m.some(t=>e===t||e.endsWith(`.${t}`))}_isDefaultTrusted(e){return f.some(t=>e===t||e.endsWith(`.${t}`))}getAll(){return{...this.trustLevels}}async reset(){this.trustLevels={},await this.save()}}const o=new v;class g{constructor(){this.prefetcher=new u,this.contextManager=new d,this.stats={totalPrefetches:0,successfulPredictions:0,timeSaved:0,startTime:Date.now()},this._setupMessageListener(),this._setupTabListener(),this._loadStats()}_setupMessageListener(){chrome.runtime.onMessage.addListener((e,t,r)=>{var s;switch(e.type){case"PREDICTION_UPDATE":this._handlePredictions(e.links,(s=t.tab)==null?void 0:s.id);break;case"GET_STATS":r(this.stats);break;case"GET_MODE":r({mode:this.contextManager.currentMode});break;case"SET_MODE":this.contextManager.setMode(e.mode);break;case"NAVIGATION_COMPLETE":this._trackSuccessfulPrediction(e.url,e.loadTime);break}return!0})}_setupTabListener(){var e,t;(t=(e=chrome.webNavigation)==null?void 0:e.onCompleted)==null||t.addListener(r=>{if(r.frameId!==0)return;const s=this.prefetcher.wasPrefetched(r.url);console.log("[InstantNav] Navigated to:",r.url,"Was prefetched?",s),s&&(this.stats.successfulPredictions++,this._saveStats())})}async _handlePredictions(e,t){const r=this.contextManager.getProfile();let s=!1;for(const a of e)o.canPrefetch(a.url)&&(a.score>=r.prerenderThreshold&&r.maxPrerender>0?o.canPrerender(a.url)?(await this.prefetcher.prerender(a.url,t),this.stats.totalPrefetches++,s=!0):(await this.prefetcher.prefetch(a.url,t),this.stats.totalPrefetches++,s=!0):a.score>=r.prefetchThreshold&&r.maxPrefetch>0?(await this.prefetcher.prefetch(a.url,t),this.stats.totalPrefetches++,s=!0):a.score>=r.preconnectThreshold?await this.prefetcher.preconnect(a.url):a.score>=30&&await this.prefetcher.dnsPrefetch(a.url));s&&this._saveStats()}_trackSuccessfulPrediction(e,t){const r=Math.max(0,2e3-t);this.stats.timeSaved+=r,this._saveStats()}async _loadStats(){try{const e=await chrome.storage.local.get("stats");e.stats&&(this.stats={...this.stats,...e.stats})}catch(e){console.error("[InstantNav] Failed to load stats:",e)}}async _saveStats(){try{await chrome.storage.local.set({stats:this.stats})}catch(e){console.error("[InstantNav] Failed to save stats:",e)}}}new g,console.log("[InstantNav] Service Worker initialized")})();
//# sourceMappingURL=service-worker.js.map
